<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥¿æ–‡å­—æ¯é…å°éŠæˆ²</title>
    <!-- è¼‰å…¥ Tailwind CSS æ¡†æ¶ï¼Œç”¨æ–¼å¿«é€Ÿæ§‹å»ºéŸ¿æ‡‰å¼ UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Inter å­—é«”ï¼Œæä¾›æ¸…æ™°ç¾ä»£çš„æ–‡å­—é¡¯ç¤º -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@700;800;900&display=swap" rel="stylesheet">
    <style>
        /* è¨­ç½®æ•´å€‹é é¢æ¨£å¼ï¼Œå±…ä¸­é¡¯ç¤ºéŠæˆ²å…§å®¹ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2fe; /* æ·ºè—è‰²èƒŒæ™¯ï¼Œæ›´æ´»æ½‘ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* æœ€å°é«˜åº¦ç‚ºè¦–çª—é«˜åº¦ */
            margin: 0;
            padding: 20px;
            box-sizing: border-box; /* ç›’æ¨¡å‹è¨­ç½® */
        }
        /* éŠæˆ²å®¹å™¨æ¨£å¼ï¼ŒåŒ…å«èƒŒæ™¯ã€åœ“è§’ã€é™°å½±å’Œå…§é‚Šè· */
        .game-container {
            background-color: #ffffff; /* ç™½è‰²èƒŒæ™¯ */
            border-radius: 2.5rem; /* æ›´å¤§åœ“è§’ï¼Œå…’ç«¥å‹å¥½ */
            box-shadow: 0 20px 30px -8px rgba(0, 0, 0, 0.15), 0 8px 12px -8px rgba(0, 0, 0, 0.08); /* æ›´æ˜é¡¯çš„é™°å½± */
            padding: 3.5rem; /* æ›´å¤šå…§é‚Šè· */
            max-width: 600px; /* å¢åŠ æœ€å¤§å¯¬åº¦ */
            width: 100%; /* ä½”æ»¿å¯ç”¨å¯¬åº¦ */
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 2rem; /* å­å…ƒç´ ä¹‹é–“çš„é–“è· */
            border: 5px solid #60a5fa; /* è—è‰²é‚Šæ¡† */
        }
        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
        .button {
            padding: 1rem 2.5rem; /* ä¸Šä¸‹å…§é‚Šè·ã€å·¦å³å…§é‚Šè· */
            border-radius: 2rem; /* å¤§åœ“è§’ï¼Œåƒç³–æœä¸€æ¨£ */
            font-weight: 800; /* å­—é«”æ›´ç²— */
            font-size: 1.5rem; /* å­—é«”æ›´å¤§ */
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease; /* éæ¸¡å‹•ç•« */
            cursor: pointer; /* é¼ æ¨™æŒ‡é‡ */
            border: none;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15); /* æŒ‰éˆ•é™°å½± */
            background-image: linear-gradient(to right, #60a5fa 0%, #3b82f6 100%); /* æ¼¸å±¤èƒŒæ™¯ */
            color: #ffffff; /* ç™½è‰²æ–‡å­— */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2); /* æ–‡å­—é™°å½± */
            display: flex; /* ä½¿ç”¨ flexbox å¯¦ç¾å…§å®¹å±…ä¸­ */
            justify-content: center;
            align-items: center;
        }
        /* æŒ‰éˆ•æ‡¸åœæ•ˆæœ */
        .button:hover {
            transform: translateY(-5px); /* å‘ä¸Šæ˜é¡¯ç§»å‹• */
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.25); /* æ›´å¤§çš„æ‡¸åœé™°å½± */
        }
        /* æŒ‰éˆ•æŒ‰ä¸‹æ•ˆæœ */
        .button:active {
            transform: translateY(-2px); /* æŒ‰ä¸‹æ™‚è¼•å¾®å›å½ˆ */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        /* ç¦ç”¨æŒ‰éˆ•æ¨£å¼ */
        .button:disabled {
            background-image: linear-gradient(to right, #9ca3af 0%, #a0aec0 100%); /* æ·ºç°è‰²æ¼¸å±¤ */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }
        /* å­—æ¯é¸æ“‡æŒ‰éˆ•çš„ç‰¹å®šæ¨£å¼ */
        .choice-button {
            width: 120px; /* å›ºå®šå¯¬åº¦ */
            height: 120px; /* å›ºå®šé«˜åº¦ */
            font-size: 4rem; /* å­—æ¯æ›´å¤§ */
            background-image: linear-gradient(to bottom right, #a78bfa 0%, #8b5cf6 100%); /* ç´«è‰²æ¼¸å±¤ */
            border: 3px solid #8b5cf6;
            margin: 0.5rem; /* é–“è· */
        }
        .choice-button:hover {
            background-image: linear-gradient(to bottom right, #c4b5fd 0%, #a78bfa 100%);
        }
        .choice-button.correct-choice {
            background-image: linear-gradient(to bottom right, #34d399 0%, #10b981 100%); /* ç­”å°ç¶ è‰² */
            border-color: #059669;
        }
        .choice-button.incorrect-choice {
            background-image: linear-gradient(to bottom right, #f87171 0%, #ef4444 100%); /* ç­”éŒ¯ç´…è‰² */
            border-color: #dc2626;
        }

        /* å›é¥‹è¨Šæ¯æ¨£å¼ */
        .feedback-message {
            font-weight: 900;
            margin-top: 1rem;
            /* è®“æ–‡å­—è‡ªå‹•æ›è¡Œ */
            white-space: normal;
            word-break: break-word;
        }
        /* æ­£ç¢ºç­”æ¡ˆè¨Šæ¯é¡è‰² */
        .correct {
            color: #10b981; /* ç¶ è‰² */
        }
        /* éŒ¯èª¤ç­”æ¡ˆè¨Šæ¯é¡è‰² */
        .incorrect {
            color: #ef4444; /* ç´…è‰² */
        }
        /* è¼‰å…¥æŒ‡ç¤ºå™¨æ¨£å¼ (æ—‹è½‰å‹•ç•«) */
        .loading-spinner {
            border: 4px solid #f3f3f3; /* æ·ºç°è‰² */
            border-top: 4px solid #3b82f6; /* è—è‰² */
            border-radius: 50%; /* åœ“å½¢ */
            width: 28px;
            height: 28px;
            animation: spin 1s linear infinite; /* æ—‹è½‰å‹•ç•« */
            display: inline-block;
            vertical-align: middle;
            margin-right: 12px;
        }
        /* æ—‹è½‰å‹•ç•«çš„é—œéµå¹€ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* è¨ˆæ™‚å™¨é€²åº¦æ¢å®¹å™¨ */
        .timer-bar-container {
            width: 100%;
            background-color: #a5d6f6; /* æ·ºè—è‰²èƒŒæ™¯ */
            border-radius: 0.75rem;
            overflow: hidden; /* ç¢ºä¿é€²åº¦æ¢åœ¨å…§éƒ¨ */
            height: 25px; /* é€²åº¦æ¢é«˜åº¦ */
            margin-top: 1rem;
            border: 2px solid #60a5fa;
        }
        /* è¨ˆæ™‚å™¨é€²åº¦æ¢æœ¬èº« */
        .timer-bar {
            height: 100%;
            width: 100%; /* åˆå§‹å¯¬åº¦ */
            background-color: #3b82f6; /* è—è‰²é€²åº¦æ¢ */
            border-radius: 0.5rem;
            transition: width linear; /* å¹³æ»‘éæ¸¡ */
        }

        /* åˆå§‹æç¤ºæ–‡å­—çš„æ¨£å¼ */
        .initial-message {
            font-weight: 800;
            color: #4a5568; /* æ·±ç°è‰² */
            /* ä½¿ç”¨ Tailwind éŸ¿æ‡‰å¼å­—é«”å¤§å° */
            font-size: 2.25rem; /* é è¨­ text-4xl */
        }
        /* Small screen specific adjustments for initial message */
        @media (min-width: 640px) { /* Tailwind's sm breakpoint */
            .initial-message {
                font-size: 3rem; /* sm:text-5xl */
            }
        }


        /* ä½¿ nextRoundBtn åœ¨å•Ÿç”¨æ™‚å…·æœ‰è¦–è¦ºå·®ç•° */
        #nextRoundBtn:not(:disabled) {
            background-image: linear-gradient(to right, #34d399 0%, #10b981 100%); /* é®®ç¶ è‰² */
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4); /* ç¶ è‰²å…‰æšˆ */
            transform: translateY(0); /* ç¢ºä¿æ²’æœ‰é è¨­è®Šå½¢ */
            animation: pulse 1.5s infinite; /* æ·»åŠ å¾®å¦™çš„è„ˆè¡å‹•ç•« */
        }

        #nextRoundBtn:not(:disabled):hover {
            background-image: linear-gradient(to right, #10b981 0%, #065f46 100%); /* æ‡¸åœæ™‚é¡è‰²æ›´æ·± */
            transform: translateY(-3px); /* æ‡¸åœæ™‚è¼•å¾®ä¸Šç§» */
            box-shadow: 0 15px 25px rgba(16, 185, 129, 0.5);
        }

        /* ä¸‹ä¸€å€‹å›åˆæŒ‰éˆ•çš„è„ˆè¡å‹•ç•« */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800">è¥¿ç­ç‰™èªå­—æ¯é…å°éŠæˆ²ï¼</h1>

        <div class="flex justify-between items-center text-3xl font-bold text-gray-700">
            <div>åˆ†æ•¸: <span id="score">0</span></div>
            <div>æ™‚é–“: <span id="timer">10</span>s</div>
        </div>

        <div class="timer-bar-container">
            <div id="timerBar" class="timer-bar" style="width: 100%;"></div>
        </div>

        <div id="loadingIndicator" class="hidden text-blue-600 text-xl font-semibold">
            <div class="loading-spinner"></div> æ­£åœ¨æº–å‚™è²éŸ³...
        </div>

        <div id="letterDisplay" class="letter-display text-8xl font-black text-indigo-700 mb-6 flex items-center justify-center h-32">
            <!-- å­—æ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
            <span class="initial-message">é»æ“Šã€Œé–‹å§‹éŠæˆ²ã€æŒ‰éˆ•</span>
        </div>

        <div id="choicesContainer" class="flex flex-wrap justify-center gap-4 mb-4">
            <!-- å­—æ¯é¸æ“‡æŒ‰éˆ•å°‡åœ¨æ­¤è™•å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <button id="playAudioBtn" class="button w-full" disabled>
            ğŸµ å†è½ä¸€æ¬¡
        </button>
        <button id="nextRoundBtn" class="button w-full" disabled>
            ä¸‹ä¸€å€‹å­—æ¯ï¼ğŸš€
        </button>
        <button id="startGameBtn" class="button w-full">
            é–‹å§‹éŠæˆ²ï¼ğŸ‰
        </button>

        <div id="feedbackMessage" class="feedback-message text-xl sm:text-2xl lg:text-3xl">
            <!-- å›é¥‹è¨Šæ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>
    </div>

    <script>
        // éŠæˆ²ä¸­ä½¿ç”¨çš„è¥¿ç­ç‰™èªåŸºæœ¬å­—æ¯åˆ—è¡¨
        // é¸æ“‡è¼ƒç‚ºåŸºç¤ä¸”ç™¼éŸ³è¼ƒç‚ºç°¡å–®çš„å­—æ¯ï¼Œé¿å…é›™å­—æ¯çµ„åˆå’Œè¤‡é›œè¦å‰‡
        const spanishLetters = ['A', 'E', 'I', 'O', 'U', 'M', 'P', 'S', 'L', 'N', 'D', 'B', 'R', 'T'];
        let currentCorrectLetter = ''; // ç•¶å‰æ­£ç¢ºçš„å­—æ¯
        let score = 0; // åˆ†æ•¸
        let audioContext; // Web Audio API ä¸Šä¸‹æ–‡
        let audioSource; // éŸ³è¨Šæºç¯€é»
        let currentAudioBuffer = null; // å„²å­˜ç•¶å‰éŸ³è¨Šç·©è¡å€ï¼Œç”¨æ–¼é‡è¤‡æ’­æ”¾
        let timerInterval; // è¨ˆæ™‚å™¨é–“éš” ID
        const TIME_LIMIT = 10; // æ¯è¼ªçš„æ™‚é–“é™åˆ¶ï¼ˆç§’ï¼‰
        let timeLeft = TIME_LIMIT; // å‰©é¤˜æ™‚é–“

        // ç²å– DOM å…ƒç´ 
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        const timerBar = document.getElementById('timerBar');
        const letterDisplay = document.getElementById('letterDisplay');
        const choicesContainer = document.getElementById('choicesContainer');
        const playAudioBtn = document.getElementById('playAudioBtn');
        const nextRoundBtn = document.getElementById('nextRoundBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');

        /**
         * å°‡ Base64 å­—ä¸²è½‰æ›ç‚º ArrayBufferã€‚
         * @param {string} base64 - Base64 ç·¨ç¢¼çš„å­—ä¸²ã€‚
         * @returns {ArrayBuffer} è½‰æ›å¾Œçš„ ArrayBufferã€‚
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * å°‡ PCM (åŸå§‹éŸ³è¨Šæ•¸æ“š) è½‰æ›ç‚º WAV æ ¼å¼çš„ Blobã€‚
         * @param {Int16Array} pcm16 - 16 ä½å…ƒ PCM éŸ³è¨Šæ•¸æ“šã€‚
         * @param {number} sampleRate - å–æ¨£ç‡ã€‚
         * @returns {Blob} WAV æ ¼å¼çš„ Blob å°è±¡ã€‚
         */
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1; // å–®è²é“
            const bytesPerSample = 2; // 16 ä½å…ƒ PCM (2 ä½å…ƒçµ„)

            // WAV é ­éƒ¨ (44 ä½å…ƒçµ„)
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);

            // RIFF å€å¡Šæè¿°ç¬¦
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * bytesPerSample, true); // ChunkSize
            writeString(view, 8, 'WAVE');

            // FMT å­å€å¡Š
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Subchunk1Size (PCM ç‚º 16)
            view.setUint16(20, 1, true); // AudioFormat (PCM ç‚º 1)
            view.setUint16(22, numChannels, true); // NumChannels
            view.setUint32(24, sampleRate, true); // SampleRate
            view.setUint32(28, sampleRate * numChannels * bytesPerSample, true); // ByteRate
            view.setUint16(32, numChannels * bytesPerSample, true); // BlockAlign
            view.setUint16(34, 16, true); // BitsPerSample

            // DATA å­å€å¡Š
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * bytesPerSample, true); // Subchunk2Size

            // å°‡ WAV é ­éƒ¨å’Œ PCM æ•¸æ“šçµ„åˆåˆ°ä¸€å€‹æ–°çš„ Uint8Array ä¸­
            const buffer = new Uint8Array(wavHeader.byteLength + pcm16.byteLength);
            buffer.set(new Uint8Array(wavHeader), 0);
            buffer.set(new Uint8Array(pcm16.buffer), wavHeader.byteLength);

            return new Blob([buffer], { type: 'audio/wav' });
        }

        /**
         * è¼”åŠ©å‡½æ•¸ï¼šåœ¨ DataView ä¸­å¯«å…¥å­—ä¸²ã€‚
         * @param {DataView} view - DataView å°è±¡ã€‚
         * @param {number} offset - å¯«å…¥çš„èµ·å§‹åç§»é‡ã€‚
         * @param {string} s - è¦å¯«å…¥çš„å­—ä¸²ã€‚
         */
        function writeString(view, offset, s) {
            for (let i = 0; i < s.length; i++) {
                view.setUint8(offset + i, s.charCodeAt(i));
            }
        }

        /**
         * å¾ AudioBuffer æ’­æ”¾éŸ³è¨Šã€‚
         * @param {AudioBuffer} audioBuffer - è¦æ’­æ”¾çš„ AudioBufferã€‚
         */
        async function playAudioBuffer(audioBuffer) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // å¦‚æœæœ‰å‰ä¸€å€‹éŸ³è¨Šæºï¼Œå‰‡åœæ­¢ä¸¦æ–·é–‹é€£æ¥
            if (audioSource) {
                audioSource.stop();
                audioSource.disconnect();
            }

            audioSource = audioContext.createBufferSource();
            audioSource.buffer = audioBuffer;
            audioSource.connect(audioContext.destination);
            audioSource.start(0); // å¾é ­é–‹å§‹æ’­æ”¾
        }

        /**
         * å•Ÿå‹•è¨ˆæ™‚å™¨ã€‚
         */
        function startTimer() {
            clearInterval(timerInterval); // å…ˆæ¸…é™¤ä»»ä½•ç¾æœ‰çš„è¨ˆæ™‚å™¨
            timeLeft = TIME_LIMIT;
            updateTimerDisplay(); // ç«‹å³æ›´æ–°é¡¯ç¤º
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout(); // æ™‚é–“åˆ°è™•ç†
                }
            }, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡
        }

        /**
         * æ›´æ–°è¨ˆæ™‚å™¨é¡¯ç¤ºã€‚
         */
        function updateTimerDisplay() {
            timerDisplay.textContent = timeLeft;
            timerBar.style.width = `${(timeLeft / TIME_LIMIT) * 100}%`;
            if (timeLeft <= 3) {
                timerBar.style.backgroundColor = '#ef4444'; // æœ€å¾Œ3ç§’è®Šç´…
            } else {
                timerBar.style.backgroundColor = '#3b82f6'; // æ­£å¸¸è—è‰²
            }
        }

        /**
         * è™•ç†è¨ˆæ™‚å™¨æ™‚é–“åˆ°çš„æƒ…æ³ã€‚
         */
        function handleTimeout() {
            feedbackMessage.textContent = `æ™‚é–“åˆ°ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯: ${currentCorrectLetter} ğŸ™ é»æ“Šã€Œä¸‹ä¸€å€‹å­—æ¯ã€ç¹¼çºŒï¼`;
            feedbackMessage.className = 'feedback-message incorrect text-xl sm:text-2xl lg:text-3xl'; // ç¢ºä¿æ‡‰ç”¨éŸ¿æ‡‰å¼é¡åˆ¥
            
            // æ¨™è¨˜æ­£ç¢ºç­”æ¡ˆ
            const correctButton = document.querySelector(`.choice-button[data-letter="${currentCorrectLetter}"]`);
            if (correctButton) {
                correctButton.classList.add('correct-choice');
            }
            endRound(); // çµæŸå›åˆ
        }

        /**
         * çµæŸç•¶å‰å›åˆï¼Œå•Ÿç”¨ã€Œä¸‹ä¸€å€‹å­—æ¯ã€æŒ‰éˆ•ä¸¦ç¦ç”¨å…¶ä»–æŒ‰éˆ•ã€‚
         */
        function endRound() {
            clearInterval(timerInterval); // åœæ­¢è¨ˆæ™‚å™¨
            playAudioBtn.disabled = true; // ç¦ç”¨æ’­æ”¾æŒ‰éˆ•
            nextRoundBtn.disabled = false; // å•Ÿç”¨ã€Œä¸‹ä¸€å€‹å­—æ¯ã€æŒ‰éˆ•
            startGameBtn.disabled = true; // ç¦ç”¨é–‹å§‹éŠæˆ²æŒ‰éˆ•

            // ç¦ç”¨æ‰€æœ‰é¸æ“‡æŒ‰éˆ•
            const choiceButtons = choicesContainer.querySelectorAll('.choice-button');
            choiceButtons.forEach(button => button.disabled = true);
        }

        /**
         * ç²å–ä¸¦æ’­æ”¾ç•¶å‰å­—æ¯çš„éŸ³è¨Šã€‚
         * @param {string} letter - è¦ç™¼éŸ³çš„å­—æ¯ã€‚
         */
        async function fetchAndPlayAudio(letter) {
            loadingIndicator.classList.remove('hidden'); // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
            playAudioBtn.disabled = true; // ç¦ç”¨æ’­æ”¾æŒ‰éˆ•
            
            // ç¦ç”¨æ‰€æœ‰é¸æ“‡æŒ‰éˆ•ç›´åˆ°éŸ³è¨Šæº–å‚™å¥½
            const choiceButtons = choicesContainer.querySelectorAll('.choice-button');
            choiceButtons.forEach(button => button.disabled = true);

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: `Say cheerfully: ${letter}` }] });
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseModalities: ["AUDIO"], // è¦æ±‚éŸ³è¨Šè¼¸å‡º
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Iapetus" } // é¸æ“‡æ¸…æ™°çš„ç™¼éŸ³è²éŸ³
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts" // æŒ‡å®š TTS æ¨¡å‹
                };

                const apiKey = ""; // API é‡‘é‘°ç”± Canvas ç’°å¢ƒè‡ªå‹•æä¾›
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                let response;
                let retryCount = 0;
                const maxRetries = 3; // æœ€å¤§é‡è©¦æ¬¡æ•¸
                const initialDelay = 1000; // åˆå§‹å»¶é² (1 ç§’)

                // å¯¦ä½œæŒ‡æ•¸é€€é¿ç­–ç•¥è™•ç† API å‘¼å«çš„æ½›åœ¨ç¯€æµ
                while (retryCount < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) {
                            break; // æˆåŠŸï¼Œé€€å‡ºå¾ªç’°
                        } else if (response.status === 429) { // è«‹æ±‚éå¤š (Rate Limit)
                            const delay = initialDelay * Math.pow(2, retryCount);
                            console.warn(`é€Ÿç‡é™åˆ¶å·²è§¸ç™¼ï¼Œå°‡åœ¨ ${delay} æ¯«ç§’å¾Œé‡è©¦...`);
                            await new Promise(res => setTimeout(res, delay));
                            retryCount++;
                        } else {
                            // å…¶ä»–éŒ¯èª¤ï¼Œæ‹‹å‡ºéŒ¯èª¤
                            const errorText = await response.text();
                            throw new Error(`API éŒ¯èª¤: ${response.status} ${response.statusText} - ${errorText}`);
                        }
                    } catch (error) {
                        console.error('Fetch éŒ¯èª¤:', error);
                        if (retryCount === maxRetries - 1) throw error; // æœ€å¾Œä¸€æ¬¡é‡è©¦å¤±æ•—å‰‡é‡æ–°æ‹‹å‡ºéŒ¯èª¤
                        const delay = initialDelay * Math.pow(2, retryCount);
                        console.warn(`ç™¼ç”ŸéŒ¯èª¤ï¼Œå°‡åœ¨ ${delay} æ¯«ç§’å¾Œé‡è©¦...`);
                        await new Promise(res => setTimeout(res, delay));
                        retryCount++;
                    }
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    // å¾ MIME é¡å‹ä¸­æå–å–æ¨£ç‡ï¼Œå¦‚æœæœªæ‰¾åˆ°å‰‡é è¨­ç‚º 16kHz
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    const pcmBuffer = base64ToArrayBuffer(audioData); // åŸå§‹ PCM ArrayBuffer
                    const pcm16 = new Int16Array(pcmBuffer); // åŸå§‹ PCM ç‚º Int16Array

                    const wavBlob = pcmToWav(pcm16, sampleRate); // è½‰æ›ç‚º WAV Blob

                    // ä½¿ç”¨ FileReader å°‡ Blob è®€å–ç‚º ArrayBufferï¼Œä»¥ä¾¿ AudioContext è§£ç¢¼
                    const reader = new FileReader();
                    reader.onload = async () => {
                        if (!audioContext) {
                            audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        }
                        try {
                            // è§£ç¢¼ WAV ArrayBuffer ç‚º AudioBuffer
                            const decodedBuffer = await audioContext.decodeAudioData(reader.result);
                            currentAudioBuffer = decodedBuffer; // å„²å­˜ä»¥ä¾¿é‡è¤‡æ’­æ”¾
                            await playAudioBuffer(currentAudioBuffer); // æ’­æ”¾éŸ³è¨Š
                            startTimer(); // æ’­æ”¾å¾Œç«‹å³å•Ÿå‹•è¨ˆæ™‚å™¨
                        } catch (audioError) {
                            console.error("éŸ³è¨Šè§£ç¢¼éŒ¯èª¤:", audioError);
                            feedbackMessage.textContent = 'éŸ³è¨Šè§£ç¢¼å¤±æ•—ã€‚';
                            feedbackMessage.className = 'feedback-message incorrect text-xl sm:text-2xl lg:text-3xl'; // ç¢ºä¿æ‡‰ç”¨éŸ¿æ‡‰å¼é¡åˆ¥
                            endRound(); // çµæŸå›åˆ
                        }
                    };
                    reader.readAsArrayBuffer(wavBlob); // å°‡ WAV Blob è®€å–ç‚º ArrayBuffer

                } else {
                    feedbackMessage.textContent = 'éŸ³è¨Šè¼‰å…¥å¤±æ•—æˆ–æ ¼å¼ä¸æ­£ç¢ºã€‚è«‹é»æ“Šã€Œå†è½ä¸€æ¬¡ã€æˆ–ã€Œä¸‹ä¸€å€‹å­—æ¯ã€è©¦è©¦çœ‹ã€‚';
                    feedbackMessage.className = 'feedback-message incorrect text-xl sm:text-2xl lg:text-3xl'; // ç¢ºä¿æ‡‰ç”¨éŸ¿æ‡‰å¼é¡åˆ¥
                    console.error("éŸ³è¨Šæ•¸æ“šéºå¤±æˆ–æ ¼å¼éŒ¯èª¤ (API å›æ‡‰):", result);
                    endRound(); // çµæŸå›åˆ
                }
            } catch (error) {
                feedbackMessage.textContent = 'è¼‰å…¥éŸ³è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹å†è©¦ä¸€æ¬¡ã€‚';
                feedbackMessage.className = 'feedback-message incorrect text-xl sm:text-2xl lg:text-3xl'; // ç¢ºä¿æ‡‰ç”¨éŸ¿æ‡‰å¼é¡åˆ¥
                console.error("ç²å–éŸ³è¨ŠéŒ¯èª¤:", error);
                endRound(); // çµæŸå›åˆ
            } finally {
                loadingIndicator.classList.add('hidden'); // éš±è—è¼‰å…¥æŒ‡ç¤ºå™¨
                playAudioBtn.disabled = false; // å•Ÿç”¨æ’­æ”¾æŒ‰éˆ•
                // å•Ÿç”¨é¸æ“‡æŒ‰éˆ•
                choiceButtons.forEach(button => button.disabled = false);
            }
        }

        /**
         * éš¨æ©Ÿæ‰“äº‚é™£åˆ—ã€‚
         * @param {Array} array - è¦æ‰“äº‚çš„é™£åˆ—ã€‚
         * @returns {Array} æ‰“äº‚å¾Œçš„é™£åˆ—ã€‚
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * é–‹å§‹æ–°ä¸€è¼ªéŠæˆ²ã€‚
         */
        function startNewRound() {
            // éš¨æ©Ÿé¸æ“‡ä¸€å€‹æ–°æ­£ç¢ºå­—æ¯
            // ç¢ºä¿æ–°å­—æ¯èˆ‡å‰ä¸€å€‹ä¸åŒï¼ˆå¦‚æœå¯èƒ½ï¼‰
            let newCorrectLetter;
            do {
                newCorrectLetter = spanishLetters[Math.floor(Math.random() * spanishLetters.length)];
            } while (newCorrectLetter === currentCorrectLetter && spanishLetters.length > 1);
            currentCorrectLetter = newCorrectLetter;


            feedbackMessage.textContent = ''; // æ¸…ç©ºå›é¥‹è¨Šæ¯
            nextRoundBtn.disabled = true; // ç¦ç”¨ã€Œä¸‹ä¸€å€‹å­—æ¯ã€æŒ‰éˆ•
            startGameBtn.disabled = true; // ç¦ç”¨é–‹å§‹éŠæˆ²æŒ‰éˆ•
            playAudioBtn.disabled = false; // å•Ÿç”¨ã€Œå†è½ä¸€æ¬¡ã€æŒ‰éˆ•
            
            currentAudioBuffer = null; // æ¸…é™¤ä¸Šä¸€å€‹éŸ³è¨Šç·©è¡å€
            clearInterval(timerInterval); // ç¢ºä¿æ¸…é™¤è¨ˆæ™‚å™¨
            timeLeft = TIME_LIMIT;
            updateTimerDisplay(); // æ›´æ–°è¨ˆæ™‚å™¨é¡¯ç¤º

            // ç§»é™¤ 'initial-message' æ¨£å¼ï¼Œç¢ºä¿é¡¯ç¤ºå­—æ¯æ™‚ä½¿ç”¨é è¨­çš„ 'letter-display' æ¨£å¼
            letterDisplay.classList.remove('initial-message');
            letterDisplay.textContent = currentCorrectLetter; // é¡¯ç¤ºæ­£ç¢ºå­—æ¯

            // ç”Ÿæˆé¸æ“‡é¸é …
            let choices = [currentCorrectLetter];
            let incorrectChoices = [];
            const numChoices = 3; // ç¸½å…±é¡¯ç¤º3å€‹é¸é … (1å€‹æ­£ç¢º + 2å€‹éŒ¯èª¤)

            // å¾æ‰€æœ‰å­—æ¯ä¸­éš¨æ©Ÿé¸æ“‡éŒ¯èª¤é¸é …ï¼Œç¢ºä¿ä¸èˆ‡æ­£ç¢ºç­”æ¡ˆé‡è¤‡ï¼Œä¸”ä¸èˆ‡å·²é¸çš„éŒ¯èª¤é¸é …é‡è¤‡
            while (incorrectChoices.length < numChoices - 1) {
                const randomLetter = spanishLetters[Math.floor(Math.random() * spanishLetters.length)];
                if (randomLetter !== currentCorrectLetter && !incorrectChoices.includes(randomLetter)) {
                    incorrectChoices.push(randomLetter);
                }
            }
            choices = choices.concat(incorrectChoices);
            shuffleArray(choices); // æ‰“äº‚é¸é …é †åº

            // æ¸…ç©ºèˆŠçš„é¸æ“‡æŒ‰éˆ•ä¸¦æ¸²æŸ“æ–°çš„
            choicesContainer.innerHTML = '';
            choices.forEach(letter => {
                const button = document.createElement('button');
                button.classList.add('button', 'choice-button');
                button.textContent = letter;
                button.setAttribute('data-letter', letter); // å„²å­˜å­—æ¯æ•¸æ“šä»¥ä¾¿æª¢æŸ¥
                button.addEventListener('click', () => handleChoice(letter, button));
                choicesContainer.appendChild(button);
            });
            
            fetchAndPlayAudio(currentCorrectLetter); // ç²å–ä¸¦æ’­æ”¾æ–°å­—æ¯çš„éŸ³è¨Š
        }

        /**
         * è™•ç†å°æœ‹å‹é¸æ“‡å­—æ¯çš„å‹•ä½œã€‚
         * @param {string} chosenLetter - å°æœ‹å‹é¸æ“‡çš„å­—æ¯ã€‚
         * @param {HTMLButtonElement} chosenButton - å°æœ‹å‹é»æ“Šçš„æŒ‰éˆ•å…ƒç´ ã€‚
         */
        function handleChoice(chosenLetter, chosenButton) {
            clearInterval(timerInterval); // åœæ­¢è¨ˆæ™‚å™¨

            // ç¦ç”¨æ‰€æœ‰é¸æ“‡æŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
            const choiceButtons = choicesContainer.querySelectorAll('.choice-button');
            choiceButtons.forEach(button => button.disabled = true);

            if (chosenLetter === currentCorrectLetter) {
                feedbackMessage.textContent = 'å¤ªæ£’äº†ï¼ä½ ç­”å°äº†ï¼ğŸ‰ é»æ“Šã€Œä¸‹ä¸€å€‹å­—æ¯ã€ç¹¼çºŒï¼';
                feedbackMessage.className = 'feedback-message correct text-xl sm:text-2xl lg:text-3xl'; // ç¢ºä¿æ‡‰ç”¨éŸ¿æ‡‰å¼é¡åˆ¥
                chosenButton.classList.add('correct-choice'); // æ¨™è¨˜ç‚ºæ­£ç¢º
                score += (timeLeft > 0 ? timeLeft : 0); // æ ¹æ“šå‰©é¤˜æ™‚é–“åŠ åˆ†ï¼Œè‡³å°‘0åˆ†
                scoreDisplay.textContent = score; // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
            } else {
                feedbackMessage.textContent = `ç­”éŒ¯äº†ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯: ${currentCorrectLetter} ğŸ™ é»æ“Šã€Œä¸‹ä¸€å€‹å­—æ¯ã€ç¹¼çºŒï¼`;
                feedbackMessage.className = 'feedback-message incorrect text-xl sm:text-2xl lg:text-3xl'; // ç¢ºä¿æ‡‰ç”¨éŸ¿æ‡‰å¼é¡åˆ¥
                chosenButton.classList.add('incorrect-choice'); // æ¨™è¨˜ç‚ºéŒ¯èª¤
                
                // æ¨™è¨˜æ­£ç¢ºç­”æ¡ˆ
                const correctButton = document.querySelector(`.choice-button[data-letter="${currentCorrectLetter}"]`);
                if (correctButton) {
                    correctButton.classList.add('correct-choice');
                }
            }
            endRound(); // çµæŸå›åˆ
        }

        // äº‹ä»¶ç›£è½å™¨

        // é»æ“Šã€Œé–‹å§‹éŠæˆ²ã€æŒ‰éˆ•æ™‚å•Ÿå‹•éŠæˆ²
        startGameBtn.addEventListener('click', () => {
            startGameBtn.disabled = true; // ç¦ç”¨é–‹å§‹æŒ‰éˆ•
            score = 0; // é‡ç½®åˆ†æ•¸
            scoreDisplay.textContent = score;
            startNewRound();
        });

        // é»æ“Šã€Œå†è½ä¸€æ¬¡ã€æŒ‰éˆ•æ™‚é‡æ–°æ’­æ”¾éŸ³è¨Š
        playAudioBtn.addEventListener('click', () => {
            if (currentAudioBuffer) {
                playAudioBuffer(currentAudioBuffer);
            } else if (currentCorrectLetter) {
                // å¦‚æœéŸ³è¨Šç·©è¡å€æœªæº–å‚™å¥½ï¼Œå‰‡é‡æ–°ç²å–ä¸¦æ’­æ”¾
                fetchAndPlayAudio(currentCorrectLetter);
            }
        });

        // é»æ“Šã€Œä¸‹ä¸€å€‹å­—æ¯ã€æŒ‰éˆ•æ™‚é–‹å§‹æ–°ä¸€è¼ªéŠæˆ²
        nextRoundBtn.addEventListener('click', startNewRound);

        // ç•¶è¦–çª—è¼‰å…¥å®Œæˆæ™‚ï¼Œé¡¯ç¤ºåˆå§‹æç¤º
        window.onload = () => {
            // åœ¨ letterDisplay å…ƒç´ ä¸­é¡¯ç¤ºåˆå§‹æç¤ºï¼Œä¸¦ä½¿ç”¨æ–°çš„ CSS é¡ä¾†æ§åˆ¶å…¶å¤§å°
            const initialMessageSpan = document.createElement('span');
            initialMessageSpan.classList.add('initial-message');
            initialMessageSpan.textContent = 'é»æ“Šã€Œé–‹å§‹éŠæˆ²ã€æŒ‰éˆ•';
            letterDisplay.innerHTML = ''; // æ¸…ç©ºåŸæœ‰å…§å®¹
            letterDisplay.appendChild(initialMessageSpan); // åŠ å…¥æ–°çš„ span å…ƒç´ 

            playAudioBtn.disabled = true;
            nextRoundBtn.disabled = true;
            startGameBtn.disabled = false; // å•Ÿç”¨é–‹å§‹éŠæˆ²æŒ‰éˆ•
            timerDisplay.textContent = TIME_LIMIT; // é‡ç½®æ™‚é–“é¡¯ç¤º
            timerBar.style.width = '100%'; // é‡ç½®é€²åº¦æ¢
            timerBar.style.backgroundColor = '#3b82f6';
        };
    </script>
</body>
</html>
